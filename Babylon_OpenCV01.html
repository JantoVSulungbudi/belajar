<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Babylon.js AR + OpenCV.js</title>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <style>
    body,html {margin:0;overflow:hidden;height:100%;}
    #renderCanvas {width:100%;height:100%;}
    #videoInput {display:none;}
  </style>
</head>
<body>
  <canvas id="renderCanvas"></canvas>
  <video id="videoInput" autoplay playsinline></video>

<script>
let cvReady = false;

// Wait until OpenCV.js loads
cv['onRuntimeInitialized'] = () => {
  cvReady = true;
  console.log("OpenCV.js is ready");
};

// Babylon.js setup
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);
const scene = new BABYLON.Scene(engine);

// Simple light & default XR
const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);
scene.createDefaultXRExperienceAsync({ uiOptions: { sessionMode: "immersive-ar" } });

// A simple red box that we will later move
const box = BABYLON.MeshBuilder.CreateBox("box", {size:0.1}, scene);
const mat = new BABYLON.StandardMaterial("mat", scene);
mat.diffuseColor = new BABYLON.Color3(1,0,0);
box.material = mat;
box.position.z = -0.5; // half meter in front

// Start rendering
engine.runRenderLoop(()=>scene.render());
window.addEventListener("resize", ()=>engine.resize());

// Camera capture for OpenCV
const video = document.getElementById("videoInput");

navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false })
  .then(stream => { video.srcObject = stream; })
  .catch(err => console.error(err));

// Basic OpenCV loop
function processVideo(){
  if (!cvReady) { requestAnimationFrame(processVideo); return; }

  let src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
  let gray = new cv.Mat();

  // capture current video frame
  cv.imshow(src, video); // not needed, but ensures Mat is filled
  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

  // simple threshold to detect bright region (just for demo)
  let thresh = new cv.Mat();
  cv.threshold(gray, thresh, 200, 255, cv.THRESH_BINARY);

  // find contours (just example)
  let contours = new cv.MatVector();
  let hierarchy = new cv.Mat();
  cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

  if (contours.size() > 0){
      // move the box up/down depending on how many white blobs we see
      box.position.y = contours.size() * 0.05;
  }

  // cleanup
  src.delete(); gray.delete(); thresh.delete(); contours.delete(); hierarchy.delete();

  requestAnimationFrame(processVideo);
}
requestAnimationFrame(processVideo);

</script>
</body>
</html>
