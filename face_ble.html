<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Face → Number → BLE (Demo)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#111;color:#eee;display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px}
    .stage{position:relative;width:640px;max-width:90vw}
    video, canvas{width:100%;height:auto;border-radius:12px;background:#000}
    .controls{display:flex;gap:8px;align-items:center}
    .card{background:#161616;padding:12px;border-radius:10px;display:flex;gap:12px;align-items:center}
    button{background:#2563eb;border:none;padding:8px 12px;border-radius:8px;color:white;cursor:pointer}
    button.secondary{background:#2a2a2a}
    .bignum{font-size:36px;font-weight:700}
    label{display:flex;gap:8px;align-items:center}
    small{color:#aaa}
  </style>
</head>
<body>
  <h2>Face → Number → BLE (Demo)</h2>
  <div class="stage card">
    <div style="flex:1">
      <div style="position:relative">
        <video id="input_video" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>
    </div>
    <div style="width:220px;display:flex;flex-direction:column;align-items:flex-start">
      <div>
        <div class="bignum" id="numDisplay">0</div>
        <small id="numExplanation">detected faces</small>
      </div>
      <div style="height:8px"></div>
      <div class="controls">
        <button id="bleConnectBtn">Connect BLE</button>
        <button id="bleSendBtn" class="secondary">Send</button>
      </div>
      <div style="height:8px"></div>
      <label><input type="checkbox" id="autoSend"> Auto-send on change</label>
      <div style="height:8px"></div>
      <small>Service/Characteristic: <span id="bleInfo">(not connected)</span></small>
    </div>
  </div>
  <p style="max-width:640px;color:#bbb">This demo captures face landmarks using MediaPipe FaceMesh, displays a number (face count) and can send it to a BLE device using the Web Bluetooth API. Replace the BLE service/characteristic UUIDs to match your peripheral.</p>

  <!-- MediaPipe FaceMesh (prebuilt) and camera utils from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <script>
    // --- UI elements ---
    const video = document.getElementById('input_video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const numDisplay = document.getElementById('numDisplay');
    const numExplanation = document.getElementById('numExplanation');
    const bleConnectBtn = document.getElementById('bleConnectBtn');
    const bleSendBtn = document.getElementById('bleSendBtn');
    const autoSendCheckbox = document.getElementById('autoSend');
    const bleInfo = document.getElementById('bleInfo');

    // --- BLE placeholders (change these to match your device) ---
    // Example: Nordic UART Service (common in BLE demos)
    const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const TX_CHAR_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // write to this char to send data

    let bleDevice = null;
    let bleServer = null;
    let txCharacteristic = null;

    async function connectBLE() {
      try {
        bleDevice = await navigator.bluetooth.requestDevice({
          // You can use filters to narrow devices. For demo we allow all devices that expose the service.
          optionalServices: [SERVICE_UUID],
          acceptAllDevices: true
        });
        bleInfo.textContent = 'Connecting...';
        bleServer = await bleDevice.gatt.connect();
        const service = await bleServer.getPrimaryService(SERVICE_UUID);
        txCharacteristic = await service.getCharacteristic(TX_CHAR_UUID);
        bleInfo.textContent = `${bleDevice.name || 'device'} (connected)`;
        bleConnectBtn.textContent = 'Disconnect';
        bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
      } catch (err) {
        console.error('BLE connect failed', err);
        alert('BLE connect failed: ' + err.message);
        bleInfo.textContent = '(not connected)';
      }
    }

    function onDisconnected() {
      bleInfo.textContent = '(not connected)';
      bleConnectBtn.textContent = 'Connect BLE';
      bleDevice = null; bleServer = null; txCharacteristic = null;
    }

    async function disconnectBLE(){
      if (bleDevice && bleDevice.gatt.connected) await bleDevice.gatt.disconnect();
      onDisconnected();
    }

    async function sendNumberOverBLE(n){
      if (!txCharacteristic) {
        alert('Not connected to BLE TX characteristic. Click "Connect BLE" first.');
        return;
      }
      // send as ASCII digits + newline
      const text = String(n) + '\n';
      const data = new TextEncoder().encode(text);
      try {
        await txCharacteristic.writeValue(data);
        console.log('sent', text);
      } catch (err) {
        console.error('write failed', err);
      }
    }

    bleConnectBtn.addEventListener('click', async ()=>{
      if (bleDevice && bleDevice.gatt.connected) await disconnectBLE();
      else await connectBLE();
    });

    bleSendBtn.addEventListener('click', ()=>{
      sendNumberOverBLE(currentNumber);
    });

    // --- FaceMesh setup ---
    const faceMesh = new FaceMesh({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
    });

    faceMesh.setOptions({
      maxNumFaces: 2,
      refineLandmarks: true,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    faceMesh.onResults(onResults);

    // Use Mediapipe camera utils to feed the video
    const camera = new Camera(video, {
      onFrame: async () => {
        await faceMesh.send({image: video});
      },
      width: 640,
      height: 480
    });
    camera.start();

    // --- Processing / drawing ---
    let currentNumber = 0; // the number we display & send

    function onResults(results){
      // resize canvas to video size
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
        updateNumber(0, 'detected faces');
        return;
      }

      // Draw landmarks (simple)
      for (const landmarks of results.multiFaceLandmarks){
        // outline
        ctx.beginPath();
        for (let i=0;i<landmarks.length;i++){
          const x = landmarks[i].x * canvas.width;
          const y = landmarks[i].y * canvas.height;
          if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          // small dot
          ctx.fillStyle = 'rgba(0,200,255,0.9)';
          ctx.fillRect(x-1.5,y-1.5,3,3);
        }
        ctx.strokeStyle = 'rgba(0,200,255,0.6)';
        ctx.lineWidth = 1.2;
        ctx.stroke();
      }

      // For this demo: set the number to the number of faces detected
      const faceCount = results.multiFaceLandmarks.length;
      updateNumber(faceCount, 'detected faces');
    }

    function updateNumber(n, explanation){
      // only update & optionally auto-send when changed
      if (n !== currentNumber) {
        currentNumber = n;
        numDisplay.textContent = String(n);
        numExplanation.textContent = explanation;
        if (autoSendCheckbox.checked) sendNumberOverBLE(n);
      }
    }

    // --- Helpful note for cross-origin and HTTPS ---
    // Web Bluetooth and getUserMedia require HTTPS (or localhost). Run on https or use localhost for development.
    // Also make sure your BLE peripheral supports the service/characteristic you set above. Replace the UUID constants if needed.

  </script>
</body>
</html>
