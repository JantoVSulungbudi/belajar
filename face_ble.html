<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Face Mesh + BLE</title>
<style>
  body {
    margin: 0;
    background: #111;
    color: #eee;
    font-family: system-ui;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px;
  }
  .stage {
    position: relative;
    width: 640px;
    max-width: 95vw;
    height: 480px;
  }
  video, canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 12px;
  }
  video { z-index: 1; }
  canvas { z-index: 2; pointer-events: none; }
  .panel { margin-top: 10px; display: flex; gap: 12px; }
  .metrics { margin-top: 10px; font-size: 14px; }
  label { cursor: pointer; }
</style>
</head>
<body>
<h2>Face Mesh + BLE</h2>

<div class="stage">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
</div>

<div class="panel">
  <label><input type="checkbox" id="toggleVideo" checked /> Show Video</label>
  <label><input type="checkbox" id="toggleMesh" checked /> Show Mesh</label>
</div>

<div class="metrics">
  Mouth: <span id="mouthVal">0</span> | 
  Left Eye: <span id="leftEyeVal">0</span> | 
  Right Eye: <span id="rightEyeVal">0</span>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const toggleVideo = document.getElementById("toggleVideo");
const toggleMesh = document.getElementById("toggleMesh");
const mouthVal = document.getElementById("mouthVal");
const leftEyeVal = document.getElementById("leftEyeVal");
const rightEyeVal = document.getElementById("rightEyeVal");

// ✅ Keep video + canvas always in DOM, toggle visibility only
toggleVideo.addEventListener("change", () => {
  video.style.visibility = toggleVideo.checked ? "visible" : "hidden";
});
toggleMesh.addEventListener("change", () => {
  canvas.style.visibility = toggleMesh.checked ? "visible" : "hidden";
});

// ✅ Setup FaceMesh
const faceMesh = new FaceMesh({
  locateFile: (file) =>
    `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
});
faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5,
});

faceMesh.onResults(onResults);

// ✅ Setup Camera
const camera = new Camera(video, {
  onFrame: async () => {
    await faceMesh.send({ image: video });
  },
  width: 640,
  height: 480,
});
camera.start();

// ✅ Draw results
function onResults(results) {
  if (!results.multiFaceLandmarks?.length) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    return;
  }

  const lm = results.multiFaceLandmarks[0];
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (toggleMesh.checked) {
    ctx.fillStyle = "rgba(0,255,255,0.9)";
    lm.forEach((p) => {
      const x = p.x * canvas.width;
      const y = p.y * canvas.height;
      ctx.fillRect(x - 1, y - 1, 2, 2);
    });
  }

  // Compute mouth + eyes openness as simple examples
  const dist = (a, b) => Math.hypot(a.x - b.x, a.y - b.y);
  const mouthOpen = dist(lm[13], lm[14]);
  const leftEyeOpen = dist(lm[159], lm[145]);
  const rightEyeOpen = dist(lm[386], lm[374]);

  mouthVal.textContent = mouthOpen.toFixed(3);
  leftEyeVal.textContent = leftEyeOpen.toFixed(3);
  rightEyeVal.textContent = rightEyeOpen.toFixed(3);
}
</script>
</body>
</html>
